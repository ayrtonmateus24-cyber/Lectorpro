<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector Pro - Arquitetura de Leitura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
      <!-- Favicon inicial -->
    <link id="dynamic-favicon" rel="icon" type="image/svg+xml" href="">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #E2E2E2; border-radius: 10px; }
        .timer-text { font-variant-numeric: tabular-nums; }
        .modal-backdrop { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(8px); }
        @keyframes gold-shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .shimmer-gold { background: linear-gradient(90deg, #fbbf24 25%, #fef3c7 50%, #fbbf24 75%); background-size: 200% 100%; animation: gold-shimmer 2s infinite linear; }
        
        @keyframes pulse-indigo {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }
        .animate-pulse-success { animation: pulse-indigo 1s ease-out; }
        
        .mode-tab-active { @apply bg-white text-indigo-600 shadow-sm; }
    </style>
</head>
</head>
<body class="bg-[#FDFCF8] text-[#2C3E50] selection:bg-indigo-100 overflow-x-hidden text-left">

    <!-- TOASTS -->
    <div id="toast-container" class="fixed bottom-8 right-8 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <!-- MODAL DELETE -->
    <div id="delete-modal" class="fixed inset-0 z-[300] modal-backdrop flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-[2.5rem] p-8 max-w-sm w-full mx-4 shadow-2xl transform scale-95 transition-all" id="delete-modal-content">
            <div class="flex flex-col items-center text-center space-y-4">
                <div class="p-4 bg-rose-50 text-rose-500 rounded-full"><i data-lucide="alert-triangle" class="w-8 h-8"></i></div>
                <h3 class="text-xl font-black text-stone-800 tracking-tight">Eliminar Livro?</h3>
                <p class="text-sm text-stone-500">Esta acção apagará permanentemente o progresso e notas.</p>
                <div class="flex gap-3 w-full pt-2">
                    <button onclick="UI.closeDeleteModal()" class="flex-1 py-4 font-bold text-stone-400 hover:bg-stone-50 rounded-2xl transition-all">Cancelar</button>
                    <button id="confirm-delete-btn" class="flex-1 py-4 bg-rose-500 text-white rounded-2xl font-black shadow-lg shadow-rose-100 active:scale-95 transition-all">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL NEW READING -->
    <div id="new-reading-modal" class="fixed inset-0 z-[200] modal-backdrop flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-[2.5rem] p-8 md:p-10 max-w-md w-full mx-4 shadow-2xl transform scale-95 transition-all" id="new-reading-content">
            <div class="flex items-center gap-3 mb-6">
                <div class="p-3 bg-indigo-100 text-indigo-600 rounded-2xl"><i data-lucide="sparkles"></i></div>
                <h2 class="text-2xl font-black text-stone-800 tracking-tighter">Nova Jornada</h2>
            </div>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-stone-400 uppercase ml-1">Título do Livro</label>
                    <input type="text" id="new-book-title" placeholder="Ex: Sapiens" class="w-full px-5 py-4 bg-stone-50 rounded-2xl border-2 border-stone-100 focus:border-indigo-300 focus:bg-white outline-none transition-all font-semibold">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-stone-400 uppercase ml-1">Total de Páginas</label>
                    <input type="number" id="new-book-pages" value="100" class="w-full px-5 py-4 bg-stone-50 rounded-2xl border-2 border-stone-100 focus:border-indigo-300 focus:bg-white outline-none font-bold">
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="UI.closeModal()" class="flex-1 py-4 font-bold text-stone-400 hover:bg-stone-50 rounded-2xl transition-all">Voltar</button>
                    <button onclick="Library.confirmNew()" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg active:scale-95 transition-all">Começar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NAVEGAÇÃO -->
    <nav class="fixed top-0 w-full bg-white/90 backdrop-blur-md border-b border-stone-200 z-50">
        <!-- BARRA DE PROGRESSO AMPLIADA -->
        <div class="max-w-5xl mx-auto h-3 w-full bg-stone-100 overflow-hidden">
            <div id="progress-bar" class="h-full bg-gradient-to-r from-orange-400 to-orange-600 transition-all duration-1000 w-0 shadow-sm relative">
                <div class="absolute inset-0 bg-white/10 animate-pulse"></div>
            </div>
        </div>
        
        <div class="max-w-5xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div id="level-badge" class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg transition-all duration-500">
                    <span id="level-number" class="font-black text-sm">1</span>
                </div>
                <div>
                    <span id="rank-title" class="block text-[9px] font-black uppercase text-indigo-500 tracking-widest leading-none mb-1 text-left">Iniciante</span>
                    <span id="current-book-title-nav" class="block text-sm font-bold text-stone-800 truncate max-w-[120px] md:max-w-xs leading-none text-left">Carregando...</span>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <div id="save-indicator" class="hidden text-[8px] font-black text-green-500 uppercase bg-green-50 px-2 py-1 rounded-md border border-green-100">Sincronizado</div>
                
                <button onclick="Audio.toggle()" id="btn-audio" class="p-2 text-stone-400 hover:text-indigo-600 transition-colors" title="Alternar Som">
                    <i data-lucide="volume-2" id="icon-audio" class="w-5 h-5"></i>
                </button>

                <button onclick="UI.toggleLibrary()" class="relative p-2 text-stone-400 hover:text-indigo-600 transition-colors">
                    <i data-lucide="library" class="w-6 h-6"></i>
                    <span id="library-count-badge" class="absolute top-0 right-0 w-4 h-4 bg-indigo-600 text-white text-[8px] font-black rounded-full flex items-center justify-center border-2 border-white">0</span>
                </button>
                <div class="h-8 w-px bg-stone-100"></div>
                <div class="text-sm font-bold text-orange-600 bg-orange-50 px-3 py-1 rounded-full border border-orange-100 shadow-sm">
                    <span id="current-page-display">0</span> / <span id="total-pages-display">0</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto px-6 pt-36 pb-20 grid grid-cols-1 lg:grid-cols-12 gap-12">
        <!-- COLUNA ESQUERDA -->
        <section class="lg:col-span-7 space-y-8">
            <div id="timer-card" class="bg-white rounded-[2.5rem] p-10 border border-stone-200 shadow-xl shadow-stone-200/50 text-center space-y-8 relative overflow-hidden transition-all duration-500">
                <div class="flex p-1.5 bg-stone-100 rounded-2xl max-w-sm mx-auto relative z-10">
                    <button onclick="Timer.changeMode('focus')" id="tab-focus" class="flex-1 py-2 text-xs font-bold rounded-xl transition-all mode-tab-active">Foco</button>
                    <button onclick="Timer.changeMode('short')" id="tab-short" class="flex-1 py-2 text-xs font-bold rounded-xl transition-all text-stone-500">Curto</button>
                    <button onclick="Timer.changeMode('long')" id="tab-long" class="flex-1 py-2 text-xs font-bold rounded-xl transition-all text-stone-500">Longo</button>
                </div>

                <div id="timer-display" class="timer-text text-[90px] md:text-[110px] font-extralight tracking-tighter text-stone-900 leading-none">25:00</div>
                
                <div class="flex justify-center gap-6 relative z-10">
                    <button id="btn-toggle" class="group flex items-center gap-3 px-10 py-5 rounded-2xl font-black text-lg bg-indigo-600 text-white transition-all active:scale-95 shadow-xl">
                        <i id="toggle-icon" data-lucide="play" class="w-6 h-6 fill-current"></i>
                        <span id="toggle-label">INICIAR</span>
                    </button>
                    <button id="btn-reset" class="p-5 rounded-2xl border-2 border-stone-100 text-stone-300 hover:text-stone-600 transition-all active:scale-90"><i data-lucide="rotate-ccw" class="w-6 h-6"></i></button>
                </div>

                <div class="pt-8 border-t border-stone-100 grid grid-cols-2">
                    <div class="text-center border-r border-stone-50"><p id="stat-sessions" class="text-2xl font-bold text-stone-800">0</p><p class="text-[9px] font-black uppercase text-stone-400">Ciclos</p></div>
                    <div class="text-center"><p id="stat-xp-today" class="text-2xl font-bold text-indigo-500">+0</p><p class="text-[9px] font-black uppercase text-indigo-400">XP Ganhos</p></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- CONTROLO DE TEMPOS E PROGRESSO -->
                <div class="bg-white rounded-3xl p-6 border border-stone-200 shadow-sm space-y-6">
                    <div>
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-xs uppercase tracking-widest text-stone-400 leading-none">Tempos (min)</h3></div>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="space-y-1">
                                <label class="text-[8px] font-black text-stone-300 uppercase block ml-1 text-left">Foco</label>
                                <input type="number" id="config-focus" class="w-full p-2 bg-stone-50 rounded-xl border-2 border-transparent focus:border-indigo-100 font-bold text-center text-sm outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[8px] font-black text-stone-300 uppercase block ml-1 text-left">Curto</label>
                                <input type="number" id="config-short" class="w-full p-2 bg-stone-50 rounded-xl border-2 border-transparent focus:border-indigo-100 font-bold text-center text-sm outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[8px] font-black text-stone-300 uppercase block ml-1 text-left">Longo</label>
                                <input type="number" id="config-long" class="w-full p-2 bg-stone-50 rounded-xl border-2 border-transparent focus:border-indigo-100 font-bold text-center text-sm outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t border-stone-50">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-xs uppercase tracking-widest text-stone-400 leading-none">Progresso</h3><button onclick="UI.openModal()" class="text-[9px] font-black text-indigo-600 uppercase bg-indigo-50 px-2 py-1 rounded-lg">Novo Livro</button></div>
                        <label class="text-[8px] font-black text-stone-300 uppercase block ml-1 mb-1 text-left">Página Atual</label>
                        <input type="number" id="input-current" class="w-full p-4 bg-stone-50 rounded-2xl border-2 border-transparent focus:border-indigo-100 font-bold text-center text-xl outline-none transition-all shadow-inner">
                    </div>
                </div>

                <div class="bg-stone-900 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden group">
                    <div class="relative z-10 text-left">
                        <h4 class="text-[10px] font-black uppercase opacity-50 tracking-widest text-indigo-400">Evolução do Leitor</h4>
                        <p id="xp-total-display" class="text-2xl font-black tracking-tighter">0 XP</p>
                        <p class="text-[9px] font-bold mt-2 opacity-60 italic leading-tight">Suba de nível a cada 500 XP acumulados.</p>
                    </div>
                    <div class="absolute -bottom-4 -right-4 opacity-10 group-hover:scale-110 transition-transform"><i data-lucide="award" class="w-24 h-24 text-white"></i></div>
                </div>
            </div>
        </section>

        <!-- COLUNA DIREITA -->
        <section class="lg:col-span-5 space-y-6 text-left">
            <div class="sticky top-32 space-y-6">
                <!-- PAINEL BIBLIOTECA -->
                <div id="library-panel" class="hidden animate-in fade-in slide-in-from-right-4 duration-300">
                    <div class="bg-stone-900 text-white rounded-[2.5rem] p-6 shadow-2xl space-y-4 border border-white/5">
                        <div class="flex justify-between items-center border-b border-white/10 pb-4">
                            <h3 class="text-xs font-black uppercase tracking-widest text-indigo-400 flex items-center gap-2"><i data-lucide="library" class="w-4 h-4"></i> Minha Estante</h3>
                            <button onclick="UI.toggleLibrary()" class="p-2 hover:bg-white/10 rounded-full transition-colors"><i data-lucide="x" class="w-4 h-4 text-stone-400"></i></button>
                        </div>
                        <div id="library-list" class="space-y-3 max-h-[350px] overflow-y-auto custom-scrollbar pr-1"></div>
                    </div>
                </div>

                <!-- PAINEL NOTAS (REFORMULADO) -->
                <div id="notes-panel" class="bg-white rounded-[2.5rem] border border-stone-200 shadow-sm overflow-hidden flex flex-col transition-all text-left">
                    <div class="p-6 border-b border-stone-100 bg-stone-50/50 flex justify-between items-center">
                        <h3 class="font-bold flex items-center gap-2 text-stone-700 tracking-tight leading-none"><i data-lucide="feather" class="w-4 h-4 text-indigo-500"></i> Notas de Insights</h3>
                        <span id="note-count" class="text-[10px] font-black text-white bg-indigo-600 px-2.5 py-1 rounded-full shadow-sm leading-none">0</span>
                    </div>
                    <div class="p-6">
                        <!-- Content Area Reformulada -->
                        <div class="mb-6 overflow-hidden rounded-[1.5rem] border-2 border-stone-50 focus-within:border-indigo-100 bg-stone-50 transition-all">
                            <textarea id="note-input" placeholder="Que insight tiveste agora?" class="w-full p-4 bg-transparent outline-none text-sm min-h-[120px] resize-none leading-relaxed block border-0 focus:ring-0" style="box-shadow: none;"></textarea>
                            <div class="flex justify-end p-2 border-t border-stone-100 bg-white/50">
                                <button id="btn-add-note" class="px-4 py-2 bg-stone-900 text-white text-xs font-bold rounded-xl hover:bg-indigo-600 transition-all shadow-sm active:scale-95 flex items-center gap-2">
                                    <span>Salvar Nota</span>
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        <div id="notes-container" class="space-y-3 max-h-[250px] overflow-y-auto pr-2 custom-scrollbar"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // ==========================================
        // 1. ESTADO GLOBAL
        // ==========================================
        let state = {
            totalXP: 0, 
            level: 1, 
            xpToday: 0, 
            isAudioEnabled: true,
            currentBook: { id: Date.now(), title: "O Alquimista", currentPage: 0, totalPages: 100, notes: [], sessions: 0 },
            library: [], 
            durations: { focus: 25, short: 5, long: 15 }, 
            timeLeft: 25 * 60, 
            isActive: false, 
            mode: 'focus',
            startPage: 0
        };

        const ranks = [
            { lv: 1, title: "Iniciante", color: "#4f46e5" }, 
            { lv: 5, title: "Explorador", color: "#6366f1" },
            { lv: 10, title: "Analista", color: "#8b5cf6" }, 
            { lv: 20, title: "Erudito", color: "#a855f7" },
            { lv: 50, title: "Lenda Viva", color: "#f97316" }
        ];

        let timerInterval = null;
        let bookToDeleteId = null;

        // ==========================================
        // 2. MÓDULO DE STORAGE
        // ==========================================
        const Storage = {
            save: () => {
                localStorage.setItem('lector_v7_data', JSON.stringify(state));
                UI.showSaveIndicator();
            },
            load: () => {
                const saved = localStorage.getItem('lector_v7_data');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                    state.isActive = false;
                    state.timeLeft = state.durations[state.mode] * 60;
                }
            }
        };

        // ==========================================
        // 3. MÓDULO DE ÁUDIO
        // ==========================================
        const Audio = {
            ctx: null,
            init: () => {
                if (!Audio.ctx) Audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            playAlarm: (type) => {
                if (!state.isAudioEnabled) return;
                Audio.init();
                const osc = Audio.ctx.createOscillator();
                const gain = Audio.ctx.createGain();
                osc.connect(gain); gain.connect(Audio.ctx.destination);
                if (type === 'focus') {
                    osc.frequency.setValueAtTime(440, Audio.ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(880, Audio.ctx.currentTime + 0.5);
                } else {
                    osc.frequency.setValueAtTime(660, Audio.ctx.currentTime);
                    osc.frequency.setValueAtTime(523, Audio.ctx.currentTime + 0.2);
                }
                gain.gain.setValueAtTime(0.1, Audio.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, Audio.ctx.currentTime + 0.5);
                osc.start(); osc.stop(Audio.ctx.currentTime + 0.5);
            },
            toggle: () => {
                state.isAudioEnabled = !state.isAudioEnabled;
                UI.updateAudioIcon();
                Storage.save();
                UI.showToast(state.isAudioEnabled ? "Som Ativado" : "Modo Mudo", "", state.isAudioEnabled ? "volume-2" : "volume-x");
            }
        };

        // ==========================================
        // 4. MÓDULO DE GAMIFICAÇÃO
        // ==========================================
        const Gamification = {
            addXP: (amount, reason) => {
                state.totalXP += amount;
                state.xpToday += amount;
                Gamification.checkLevel();
                Storage.save();
                UI.updateAll();
                UI.showToast(`+${amount} XP`, reason, "zap");
            },
            checkLevel: () => {
                const next = state.level * 500;
                if (state.totalXP >= next) {
                    state.level++;
                    confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 } });
                    UI.showToast(`Nível ${state.level}!`, "Subiste de patente", "award");
                }
            }
        };

        // ==========================================
        // 5. MÓDULO DE BIBLIOTECA
        // ==========================================
        const Library = {
            confirmNew: () => {
                const titleInput = document.getElementById('new-book-title');
                const pagesInput = document.getElementById('new-book-pages');
                const title = titleInput.value.trim() || "Sem Título";
                const pages = parseInt(pagesInput.value) || 100;
                
                state.library.unshift({ ...state.currentBook });
                state.currentBook = { id: Date.now(), title, currentPage: 0, totalPages: pages, notes: [], sessions: 0 };
                Timer.reset();
                Storage.save(); 
                UI.updateAll(); 
                UI.closeModal();
                UI.showToast("Novo Livro", title, "book");
                titleInput.value = "";
            },
            switch: (id) => {
                const idx = state.library.findIndex(b => b.id === id);
                if (idx === -1) return;
                const backup = { ...state.currentBook };
                state.currentBook = { ...state.library[idx] };
                state.library.splice(idx, 1, backup);
                Timer.reset(); Storage.save(); UI.updateAll(); UI.toggleLibrary();
                UI.showToast("Livro Trocado", state.currentBook.title, "refresh-cw");
            },
            delete: (id) => {
                state.library = state.library.filter(b => b.id !== id);
                Storage.save(); UI.renderLibrary(); UI.updateAll(); UI.closeDeleteModal();
                UI.showToast("Livro Eliminado", "Removido da estante", "trash-2");
            }
        };

        // ==========================================
        // 6. MÓDULO DE TIMER
        // ==========================================
        const Timer = {
            toggle: () => {
                Audio.init();
                if (Audio.ctx.state === 'suspended') Audio.ctx.resume();
                if (!state.isActive) {
                    state.isActive = true;
                    state.startPage = state.currentBook.currentPage;
                    timerInterval = setInterval(() => {
                        if (state.timeLeft > 0) { state.timeLeft--; UI.updateTimer(); }
                        else { Timer.complete(); }
                    }, 1000);
                } else {
                    state.isActive = false; clearInterval(timerInterval);
                }
                UI.updateTimerControls();
            },
            reset: () => {
                state.isActive = false; clearInterval(timerInterval);
                state.timeLeft = state.durations[state.mode] * 60;
                UI.updateTimer(); UI.updateTimerControls();
            },
            complete: () => {
                clearInterval(timerInterval); state.isActive = false;
                Audio.playAlarm(state.mode);
                const card = document.getElementById('timer-card');
                if (card) {
                    card.classList.add('animate-pulse-success');
                    setTimeout(() => card.classList.remove('animate-pulse-success'), 1000);
                }

                if (state.mode === 'focus') { 
                    state.currentBook.sessions++; 
                    Gamification.addXP(150, "Foco Concluído"); 
                    const nextMode = (state.currentBook.sessions % 4 === 0) ? 'long' : 'short';
                    UI.showToast(nextMode === 'long' ? "Hora do Descanso Longo" : "Hora da Pausa Curta", "Excelente progresso!", "coffee");
                    Timer.changeMode(nextMode);
                } else {
                    UI.showToast("Pausa Terminada", "Pronto para voltar ao livro?", "book-open");
                    Timer.changeMode('focus');
                }
                UI.updateAll();
            },
            changeMode: (m) => {
                state.mode = m; Timer.reset(); UI.updateTabs();
            }
        };

        // ==========================================
        // 7. MÓDULO DE UI
        // ==========================================
        const UI = {
           updateFavicon: () => {
                const favicon = document.getElementById('dynamic-favicon');
                if (!favicon) return;

                const svgs = {
                    standby: `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234f46e5' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'><path d='M4 19.5A2.5 2.5 0 0 1 6.5 17H20'></path><path d='M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z'></path></svg>`,
                    focus: `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23f97316' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'><path d='M4 19.5A2.5 2.5 0 0 1 6.5 17H20'></path><path d='M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z'></path></svg>`,
                    short: `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2322c55e' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'><path d='M18 8h1a4 4 0 0 1 0 8h-1'></path><path d='M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z'></path><line x1='6' y1='1' x2='6' y2='4'></line><line x1='10' y1='1' x2='10' y2='4'></line><line x1='14' y1='1' x2='14' y2='4'></line></svg>`,
                    long: `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'><path d='M18 8h1a4 4 0 0 1 0 8h-1'></path><path d='M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z'></path><line x1='6' y1='1' x2='6' y2='4'></line><line x1='10' y1='1' x2='10' y2='4'></line><line x1='14' y1='1' x2='14' y2='4'></line></svg>`
                };

                let target = 'standby';
                if (state.isActive) {
                    target = state.mode;
                }

                favicon.href = svgs[target];
            updateAll: () => {
                // Progress Bar
                const bookP = (state.currentBook.currentPage / state.currentBook.totalPages) * 100 || 0;
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) {
                    progressBar.style.width = `${Math.min(bookP, 100)}%`;
                    if (bookP >= 100) progressBar.classList.add('shimmer-gold');
                    else progressBar.classList.remove('shimmer-gold');
                }
                
                // XP Progress - CORREÇÃO DE SEGURANÇA (Null Checks)
                const currentLevelStartXP = (state.level - 1) * 500;
                const xpInLevel = state.totalXP - currentLevelStartXP;
                const xpPercentage = (xpInLevel / 500) * 100;
                const xpProgress = document.getElementById('xp-progress');
                if (xpProgress) {
                    xpProgress.style.width = `${Math.min(xpPercentage, 100)}%`;
                }
                
                // Texto Dinâmico
                const elements = {
                    'level-number': state.level,
                    'current-book-title-nav': state.currentBook.title,
                    'current-page-display': state.currentBook.currentPage,
                    'total-pages-display': state.currentBook.totalPages,
                    'input-current': state.currentBook.currentPage,
                    'stat-sessions': state.currentBook.sessions,
                    'stat-xp-today': `+${state.xpToday}`,
                    'xp-total-display': `${state.totalXP} XP`,
                    'note-count': state.currentBook.notes.length,
                    'library-count-badge': state.library.length,
                    'config-focus': state.durations.focus,
                    'config-short': state.durations.short,
                    'config-long': state.durations.long
                };

                for (const [id, value] of Object.entries(elements)) {
                    const el = document.getElementById(id);
                    if (el) {
                        if (el.tagName === 'INPUT') el.value = value;
                        else el.innerText = value;
                    }
                }

                const currentRank = [...ranks].reverse().find(r => state.level >= r.lv) || ranks[0];
                const rankTitleEl = document.getElementById('rank-title');
                const levelBadgeEl = document.getElementById('level-badge');
                if (rankTitleEl) {
                    rankTitleEl.innerText = currentRank.title;
                    rankTitleEl.style.color = currentRank.color;
                }
                if (levelBadgeEl) levelBadgeEl.style.backgroundColor = currentRank.color;

                UI.renderNotes(); UI.updateTimer(); UI.updateAudioIcon(); UI.updateTabs(); lucide.createIcons();
            },
            updateTimer: () => {
                const el = document.getElementById('timer-display');
                if (!el) return;
                const mins = Math.floor(state.timeLeft / 60);
                const secs = state.timeLeft % 60;
                el.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            },
            updateTimerControls: () => {
                const label = document.getElementById('toggle-label');
                const icon = document.getElementById('toggle-icon');
                if (label) label.innerText = state.isActive ? 'PAUSAR' : 'INICIAR';
                if (icon) {
                    icon.setAttribute('data-lucide', state.isActive ? 'pause' : 'play');
                    lucide.createIcons();
                }
            },
            updateAudioIcon: () => {
                const icon = document.getElementById('icon-audio');
                if (icon) {
                    icon.setAttribute('data-lucide', state.isAudioEnabled ? 'volume-2' : 'volume-x');
                    lucide.createIcons();
                }
            },
            updateTabs: () => {
                ['focus', 'short', 'long'].forEach(m => {
                    const btn = document.getElementById(`tab-${m}`);
                    if(btn) btn.className = `flex-1 py-2 text-xs font-bold rounded-xl transition-all ${state.mode === m ? 'mode-tab-active' : 'text-stone-500 hover:text-stone-700'}`;
                });
            },
            renderNotes: () => {
                const container = document.getElementById('notes-container');
                if (!container) return;
                if (state.currentBook.notes.length === 0) {
                    container.innerHTML = `<p class="text-[10px] text-center text-stone-300 py-6 italic">Sem notas ainda.</p>`;
                    return;
                }
                container.innerHTML = state.currentBook.notes.map(n => `
                    <div class="bg-stone-50 border p-3 rounded-2xl animate-in slide-in-from-bottom-2 text-left">
                        <div class="flex justify-between text-[8px] font-black text-indigo-400 mb-1 uppercase tracking-tighter"><span>Pág. ${n.page}</span><span>${n.time}</span></div>
                        <p class="text-[11px] text-stone-700 leading-tight font-medium">"${n.text}"</p>
                    </div>
                `).join('');
            },
            renderLibrary: () => {
                const list = document.getElementById('library-list');
                if (!list) return;
                if (state.library.length === 0) {
                    list.innerHTML = `<p class="text-[10px] text-center text-stone-500 py-10 italic">Estante vazia.</p>`;
                    return;
                }
                list.innerHTML = state.library.map(b => `
                    <div class="bg-white/5 p-4 rounded-3xl border border-white/5 hover:border-indigo-500/50 transition-all group relative text-left">
                        <div class="flex justify-between items-start mb-3">
                            <div class="max-w-[70%]"><h4 class="text-xs font-black truncate text-white uppercase">${b.title}</h4><p class="text-[9px] text-stone-500">${b.notes.length} notas</p></div>
                            <span class="text-[8px] font-black text-indigo-400 bg-indigo-500/20 px-1.5 rounded-full">${Math.round((b.currentPage/b.totalPages)*100)}%</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="Library.switch(${b.id})" class="flex-1 py-2 bg-indigo-600 hover:bg-indigo-500 text-[9px] font-black text-white rounded-xl uppercase transition-all tracking-widest">Ler Agora</button>
                            <button onclick="UI.openDeleteModal(${b.id})" class="p-2 bg-rose-500/10 text-rose-400 hover:bg-rose-500 hover:text-white rounded-xl transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            },
            showToast: (title, msg, icon) => {
                const container = document.getElementById('toast-container');
                if (!container) return;
                const t = document.createElement('div');
                t.className = 'flex items-center gap-4 bg-white border border-stone-200 p-4 rounded-2xl shadow-2xl transition-all duration-500 opacity-0 translate-x-10 pointer-events-auto text-left';
                t.innerHTML = `<div class="p-2 bg-indigo-50 text-indigo-600 rounded-xl"><i data-lucide="${icon}" class="w-5 h-5"></i></div>
                               <div><p class="text-xs font-black text-stone-800 leading-tight">${title}</p><p class="text-[10px] text-stone-500 leading-tight">${msg}</p></div>`;
                container.appendChild(t); lucide.createIcons();
                setTimeout(() => { t.classList.replace('opacity-0', 'opacity-100'); t.classList.replace('translate-x-10', 'translate-x-0'); }, 10);
                setTimeout(() => { t.classList.replace('opacity-100', 'opacity-0'); t.classList.add('translate-x-10'); setTimeout(() => t.remove(), 500); }, 4000);
            },
            showSaveIndicator: () => {
                const ind = document.getElementById('save-indicator');
                if(ind) { ind.classList.remove('hidden'); setTimeout(() => ind.classList.add('hidden'), 2000); }
            },
            openModal: () => { 
                const m = document.getElementById('new-reading-modal');
                if (!m) return;
                m.classList.remove('hidden'); 
                setTimeout(() => {
                    m.classList.add('opacity-100');
                    const content = document.getElementById('new-reading-content');
                    if(content) content.classList.replace('scale-95', 'scale-100');
                }, 10); 
            },
            closeModal: () => { 
                const m = document.getElementById('new-reading-modal');
                if (!m) return;
                m.classList.replace('opacity-100', 'opacity-0'); 
                const content = document.getElementById('new-reading-content');
                if(content) content.classList.replace('scale-100', 'scale-95');
                setTimeout(() => m.classList.add('hidden'), 300); 
            },
            openDeleteModal: (id) => { 
                bookToDeleteId = id; 
                const m = document.getElementById('delete-modal'); 
                if (!m) return;
                m.classList.remove('hidden'); 
                setTimeout(() => {
                    m.classList.add('opacity-100');
                    const content = document.getElementById('delete-modal-content');
                    if(content) content.classList.replace('scale-95', 'scale-100');
                }, 10); 
            },
            closeDeleteModal: () => { 
                const m = document.getElementById('delete-modal'); 
                if (!m) return;
                m.classList.replace('opacity-100', 'opacity-0'); 
                const content = document.getElementById('delete-modal-content');
                if(content) content.classList.replace('scale-100', 'scale-95');
                setTimeout(() => m.classList.add('hidden'), 300); 
            },
            toggleLibrary: () => { 
                const panel = document.getElementById('library-panel');
                if(panel) {
                    panel.classList.toggle('hidden'); 
                    UI.renderLibrary(); 
                }
            }
        };

        // ==========================================
        // 8. BOOTSTRAP
        // ==========================================
        window.onload = () => {
            Storage.load();
            UI.updateAll();
            
            const btnToggle = document.getElementById('btn-toggle');
            const btnReset = document.getElementById('btn-reset');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const inputCurrent = document.getElementById('input-current');
            const btnAddNote = document.getElementById('btn-add-note');

            if(btnToggle) btnToggle.onclick = Timer.toggle;
            if(btnReset) btnReset.onclick = Timer.reset;
            if(confirmDeleteBtn) confirmDeleteBtn.onclick = () => Library.delete(bookToDeleteId);
            
            if(inputCurrent) {
                inputCurrent.onchange = (e) => {
                    const val = parseInt(e.target.value) || 0;
                    if (val > state.currentBook.currentPage) {
                        Gamification.addXP((val - state.currentBook.currentPage) * 10, "Páginas Lidas");
                    }
                    state.currentBook.currentPage = val; 
                    Storage.save(); UI.updateAll();
                };
            }
            
            if(btnAddNote) {
                btnAddNote.onclick = () => {
                    const input = document.getElementById('note-input');
                    if (!input || !input.value.trim()) return;
                    state.currentBook.notes.unshift({ 
                        text: input.value.trim(), 
                        page: state.currentBook.currentPage, 
                        time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) 
                    });
                    input.value = ''; 
                    Gamification.addXP(50, "Novo Insight");
                };
            }

            // Listeners for Duration Inputs
            ['focus', 'short', 'long'].forEach(mode => {
                const el = document.getElementById(`config-${mode}`);
                if(el) {
                    el.onchange = (e) => {
                        const newVal = parseInt(e.target.value) || 1;
                        state.durations[mode] = newVal;
                        if (!state.isActive && state.mode === mode) {
                            state.timeLeft = newVal * 60;
                            UI.updateTimer();
                        }
                        Storage.save();
                    };
                }
            });
        };
    </script>
</body>
</html>
